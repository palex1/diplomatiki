import streamlit as st
from google import genai
import os
import time

# ----------------------------------------------------
# 1. Διαμόρφωση & Setup
# ----------------------------------------------------

# --- ΣΗΜΕΙΟ ΠΡΟΣΟΧΗΣ: ΒΑΛΕ ΤΟ ΚΛΕΙΔΙ ΣΟΥ ΕΔΩ ---
# ΤΟ API KEY ΠΡΕΠΕΙ ΝΑ ΕΡΧΕΤΑΙ ΑΠΟ ΤΑ SECRETS ΤΟΥ STREAMLIT CLOUD
GEMINI_API_KEY = os.getenv("GEMINI_API_KEY") 
# ------------------------------------------------

# Ο κώδικας του app.py δεν πρέπει να έχει το set_page_config
# καθώς αυτό ορίζεται πλέον στο Home.py (κεντρική σελίδα).

if not GEMINI_API_KEY:
    st.error("Το API Key δεν βρέθηκε. Βεβαιωθείτε ότι έχει οριστεί στα Secrets.")
    client = None
else:
    client = genai.Client(api_key=GEMINI_API_KEY)

# ----------------------------------------------------
# 2. Sidebar (Ρυθμίσεις)
# ----------------------------------------------------
with st.sidebar:
    st.header("⚙️ Παράμετροι Μαθήματος")
    
    subject_area = st.text_input("Θέμα Μαθήματος:", value="Δομές Δεδομένων")
    grade = st.selectbox(
    "Τάξη:", 
    [
        "Α' Γυμνασίου (Εισαγωγή)", 
        "Β' Γυμνασίου (Δίκτυα & Αλγόριθμοι)",
        "Γ' Γυμνασίου (Προγραμματισμός)", 
        "Α' Λυκείου (Εισαγωγή & Εφαρμογές)", 
        "Β' Λυκείου (Προγραμματιστικό Περιβάλλον - Πληροφορική)", 
        "Γ' Λυκείου (Ανάπτυξη Εφαρμογών σε Προγρ. Περιβάλλον)", 
        "ΕΠΑΛ (Τεχνολογίες Πληροφορικής & Λογισμικού)"
    ]
)
    duration = st.selectbox("Διάρκεια:", ["45 λεπτά", "90 λεπτά"])
    method = st.selectbox("Μέθοδος:", ["Διερευνητική", "Project-Based", "Αντεστραμμένη Τάξη"])
    
    bloom_level = st.selectbox(
        "Στόχος/Επίπεδο Bloom:",
        ["Εφαρμόζω (Applying)", "Κατανοώ (Understanding)", "Δημιουργώ (Creating)", "Αναλύω (Analyzing)", "Θυμάμαι (Remembering)"]
    )
    
    st.divider()
    submit_btn = st.button(" Δημιουργία Υλικού")

# ----------------------------------------------------
# 3. Κύριο Μέρος (Tabs & Logic)
# ----------------------------------------------------
st.subheader("Σχεδιασμός Νέου Μαθήματος") 
st.write("Συμπληρώστε τις παραμέτρους για να ξεκινήσει ο σχεδιασμός του μαθήματος.")

MODEL_NAME = 'gemini-2.5-flash' 

if submit_btn and client:
    tab1, tab2, tab3 = st.tabs([" Διδακτικό Σενάριο", " Φύλλο Εργασίας", " Κουίζ Αξιολόγησης"])

    # -------------------------------------------
    # TAB 1: Διδακτικό Σενάριο
    # -------------------------------------------
    with tab1:
        st.subheader("Αναλυτικό Διδακτικό Σενάριο & Αξιολόγηση")
        with st.spinner("Σχεδιασμός σεναρίου και ρουμπρίκας..."):
            prompt_scenario = (
                f"Δράσε ως έμπειρος εκπαιδευτικός Πληροφορικής. Δημιούργησε ένα αναλυτικό διδακτικό σενάριο "
                f"για το θέμα '{subject_area}' στην τάξη '{grade}', διάρκειας {duration}. "
                f"Μέθοδος: {method}. "
                f"**Ο κύριος μαθησιακός στόχος (σύμφωνα με την Ταξινομία Bloom) είναι το επίπεδο: '{bloom_level}'.** "
                "Πριν τον πίνακα ροής, δημιούργησε μια ενότητα με τίτλο 'Προσδοκώμενα Μαθησιακά Αποτελέσματα' (Learning Outcomes) σε μορφή λίστας. "
                "Τέλος, δημιούργησε μια Ρουμπρίκα (Rubric) Αξιολόγησης σε πίνακα Markdown με 3 κριτήρια και 4 επίπεδα επίδοσης (π.χ. Άριστα, Καλά, Μέτρια, Απαράδεκτα). "
                "Παρουσίασε τη ροή του μαθήματος σε μορφή πίνακα Markdown (Χρόνος | Δραστηριότητα | Ρόλος Εκπαιδευτικού | Ρόλος Μαθητή)."
            )
            try:
                response_1 = client.models.generate_content(model=MODEL_NAME, contents=prompt_scenario)
                st.markdown(response_1.text)
            except Exception as e:
                st.error(f"Σφάλμα στο Tab 1: {e}")

    # Μικρή παύση 2 δευτερολέπτων για να μην μπλοκάρει το API
    time.sleep(2) 

    # -------------------------------------------
    # TAB 2: Φύλλο Εργασίας (Worksheet)
    # -------------------------------------------
    with tab2:
        st.subheader("Φύλλο Εργασίας Μαθητή")
        with st.spinner("Δημιουργία ασκήσεων... (Περιμένετε λίγο)"):
            prompt_worksheet = (
                f"Για το μάθημα '{subject_area}' ({grade}), φτιάξε ένα Φύλλο Εργασίας. "
                "Να έχει: Θεωρία, 2 Ασκήσεις και 1 Δραστηριότητα Κριτικής Σκέψης. "
                f"Οι ασκήσεις να στοχεύουν στο επίπεδο '{bloom_level}' της Ταξινομίας Bloom."
            )
            try:
                response_2 = client.models.generate_content(model=MODEL_NAME, contents=prompt_worksheet)
                st.markdown(response_2.text)
            except Exception as e:
                st.error(f"Σφάλμα στο Tab 2: {e}")

    # Μικρή παύση 2 δευτερολέπτων
    time.sleep(2)

    # -------------------------------------------
    # TAB 3: Κουίζ Αξιολόγησης
    # -------------------------------------------
    with tab3:
        st.subheader("Τεστ Γνώσεων")
        with st.spinner("Σύνταξη ερωτήσεων... (Περιμένετε λίγο)"):
            prompt_quiz = (
                f"Φτιάξε ένα Quiz 5 ερωτήσεων πολλαπλής επιλογής για το '{subject_area}' (Τάξη: {grade}). "
                f"Βεβαιώσου ότι οι ερωτήσεις καλύπτουν το επίπεδο '{bloom_level}' της Ταξινομίας Bloom. "
                "Στο τέλος βάλε τις λύσεις και μια σύντομη επεξήγηση για κάθε σωστή απάντηση."
            )
            try:
                response_3 = client.models.generate_content(model=MODEL_NAME, contents=prompt_quiz)
                st.markdown(response_3.text)
            except Exception as e:
                st.error(f"Σφάλμα στο Tab 3: {e}")

else:
    if not submit_btn:
        st.info(" Πατήστε 'Δημιουργία Υλικού' για να ξεκινήσετε.")
